{
  "apiVersion": "template.openshift.io/v1",
  "kind": "Template",
  "metadata": {
    "annotations": {
      "openshift.io/display-name": "Red Hat Fuse 7.11 Camel on Spring Boot 2 with Red Hat OpenShift Streams for Apache Kafka",
      "openshift.io/provider-display-name": "Red Hat, Inc.",
      "description": "Spring Boot 2, Camel and Red Hat OpenShift Streams for Apache Kafka. This example demonstrates how to run a Camel Service on Spring-Boot 2 that connects with Red Hat OpenShift Streams for Apache Kafka.",
      "tags": "quickstart,java,springboot,fis,jboss-fuse",
      "iconClass": "icon-rh-integration",
      "version": "1.11"
    },
    "name": "s2i-fuse711-spring-boot-2-camel-rhosak"
  },
  "labels": {
    "template": "s2i-fuse711-spring-boot-2-camel-rhosak"
  },
  "parameters": [
    {
      "name": "APP_NAME",
      "displayName": "Application Name",
      "required": true,
      "value": "qs-sb2-camel-rhosak",
      "description": "The name assigned to the application (max 20 characters)."
    },
    {
      "name": "GIT_REPO",
      "displayName": "Git Repository URL",
      "required": true,
      "value": "https://github.com/fabric8-quickstarts/spring-boot-camel-rhosak.git",
      "description": "The URL of the repository with your application source code."
    },
    {
      "name": "GIT_REF",
      "displayName": "Git Reference",
      "value": "spring-boot-camel-rhosak-7.11.1.fuse-sb2-7_11_1-00005",
      "description": "Set this to a branch name, tag or other ref of your repository if you are not using the default branch."
    },
    {
      "name": "KAFKA_BROKERS",
      "displayName": "Kafka brokers",
      "required": true,
      "description": "URL of the Kafka brokers to use. The format is 'host1:port1,host2:port2' and the list can be a subset of brokers or a VIP pointing to a subset of brokers. This option is known as bootstrap.servers in the Kafka documentation"
    },
    {
      "name": "SA_CLIENT_ID",
      "displayName": "Kafka Broker Service Account Client ID",
      "required": true,
      "description": "The Service Account Client ID used to authenticate with the A-MQ broker."
    },
    {
      "name": "SA_CLIENT_SECRET",
      "displayName": "Kafka Broker Service Account Client Secret",
      "required": true,
      "description": "The Service Account Client Secret used to authenticate with the A-MQ broker."
    },
    {
      "name": "TOPIC_NAME",
      "displayName": "Kafka Topic Name",
      "required": true,
      "value": "test",
      "description": "Name of the topic to use. On the consumer you can use comma to separate multiple topics. A producer can only send a message to a single topic."
    },
    {
      "name": "CONSUMER_GROUP_ID",
      "displayName": "Kafka Consumer Group ID",
      "required": true,
      "value": "kafkaGroup",
      "description": "A string that uniquely identifies the group of consumer processes to which this consumer belongs. By setting the same group id multiple processes indicate that they are all part of the same consumer group. This option is required for consumers."
    },
    {
      "name": "SEEK_TO_STRATEGY",
      "displayName": "Kafka seek to strategy",
      "required": true,
      "value": "beginning",
      "description": "Set if Kafka Consumer will read from beginning or end on startup"
    },
    {
      "name": "MAX_POLL_RECORDS",
      "displayName": "Kafka Max Poll Records",
      "required": true,
      "value": "5000",
      "description": "The maximum number of records returned in a single call to poll()."
    },
    {
      "name": "KAFKA_CONSUMERS_COUNT",
      "displayName": "Kafka Consumer Count",
      "required": true,
      "value": "1",
      "description": "The number of consumers that connect to kafka server."
    },
    {
      "name": "BASE_IMAGE_NAME",
      "displayName": "Base Image Name, JDK11 or JDK8",
      "value": "fuse7-java-openshift",
      "description": "The base image used. Default is fuse7-java-openshift which is JDK8 based; fuse7-java11-openshift is JDK11 based"
    },
    {
      "name": "BUILDER_VERSION",
      "displayName": "Builder version",
      "value": "1.11",
      "description": "The version of the Fuse S2I builder image to use."
    },
    {
      "name": "APP_VERSION",
      "displayName": "Application Version",
      "value": "7.11.1.fuse-sb2-7_11_1-00005",
      "description": "The application version."
    },
    {
      "name": "MAVEN_ARGS",
      "displayName": "Maven Arguments",
      "value": "package -DskipTests -Djkube.skip -e -B",
      "description": "Arguments passed to mvn in the build."
    },
    {
      "name": "MAVEN_ARGS_APPEND",
      "displayName": "Extra Maven Arguments",
      "description": "Extra arguments passed to mvn, e.g. for multi-module builds."
    },
    {
      "name": "MAVEN_MIRROR_URL",
      "displayName": "Maven mirror URL",
      "description": "Maven mirror to use for S2I builds.",
      "required": false
    },
    {
      "name": "ARTIFACT_DIR",
      "displayName": "Maven build directory",
      "description": "Directory of the artifact to be built, e.g. for multi-module builds."
    },
    {
      "name": "IMAGE_STREAM_NAMESPACE",
      "displayName": "Image Stream Namespace",
      "value": "openshift",
      "required": true,
      "description": "Namespace in which the Fuse ImageStreams are installed. These ImageStreams are normally installed in the OpenShift namespace. You should only need to modify this if you've installed the ImageStreams in a different namespace/project."
    },
    {
      "name": "BUILD_SECRET",
      "displayName": "Git Build Secret",
      "generate": "expression",
      "description": "The secret needed to trigger a build.",
      "from": "[a-zA-Z0-9]{40}"
    },
    {
      "name": "CPU_REQUEST",
      "displayName": "CPU request",
      "value": "0.2",
      "required": true,
      "description": "The amount of CPU to request."
    },
    {
      "name": "MEMORY_REQUEST",
      "displayName": "Memory request",
      "value": "128Mi",
      "required": true,
      "description": "The amount of memory required for the container to run."
    },
    {
      "name": "CPU_LIMIT",
      "displayName": "CPU limit",
      "value": "1.0",
      "required": true,
      "description": "The amount of CPU the container is limited to use."
    },
    {
      "name": "MEMORY_LIMIT",
      "displayName": "Memory limit",
      "value": "512Mi",
      "required": true,
      "description": "The amount of memory the container is limited to use."
    },
    {
      "name": "BUILD_MEMORY_REQUEST",
      "displayName": "Build Memory request",
      "value": "0.7G",
      "required": true,
      "description": "The amount of memory to request for builds."
    },
    {
      "name": "BUILD_MEMORY_LIMIT",
      "displayName": "Build Memory limit",
      "value": "1G",
      "required": true,
      "description": "The amount of memory the build container is limited to use."
    }
  ],
  "objects": [
    {
      "apiVersion": "v1",
      "kind": "ServiceAccount",
      "metadata": {
        "name": "${APP_NAME}",
        "labels": {
          "component": "${APP_NAME}",
          "group": "quickstarts",
          "app": "${APP_NAME}",
          "provider": "s2i",
          "version": "${APP_VERSION}"
        }
      }
    },
    {
      "kind": "ImageStream",
      "apiVersion": "image.openshift.io/v1",
      "metadata": {
        "name": "${APP_NAME}",
        "creationTimestamp": null,
        "labels": {
          "component": "${APP_NAME}",
          "group": "quickstarts",
          "app": "${APP_NAME}",
          "provider": "s2i",
          "version": "${APP_VERSION}"
        }
      },
      "spec": {
        "lookupPolicy": {
          "local": true
        }
      },
      "status": {
        "dockerImageRepository": ""
      }
    },
    {
      "kind": "BuildConfig",
      "apiVersion": "build.openshift.io/v1",
      "metadata": {
        "name": "${APP_NAME}",
        "creationTimestamp": null,
        "labels": {
          "component": "${APP_NAME}",
          "group": "quickstarts",
          "app": "${APP_NAME}",
          "provider": "s2i",
          "version": "${APP_VERSION}"
        }
      },
      "spec": {
        "triggers": [
          {
            "type": "GitHub",
            "github": {
              "secret": "${BUILD_SECRET}"
            }
          },
          {
            "type": "Generic",
            "generic": {
              "secret": "${BUILD_SECRET}"
            }
          },
          {
            "type": "ConfigChange"
          },
          {
            "type": "ImageChange",
            "imageChange": {}
          }
        ],
        "source": {
          "type": "Git",
          "git": {
            "uri": "${GIT_REPO}",
            "ref": "${GIT_REF}"
          }
        },
        "strategy": {
          "type": "Source",
          "sourceStrategy": {
            "from": {
              "kind": "ImageStreamTag",
              "namespace": "${IMAGE_STREAM_NAMESPACE}",
              "name": "${BASE_IMAGE_NAME}:${BUILDER_VERSION}"
            },
            "forcePull": true,
            "incremental": true,
            "env": [
              {
                "name": "BUILD_LOGLEVEL",
                "value": "5"
              },
              {
                "name": "ARTIFACT_DIR",
                "value": "${ARTIFACT_DIR}"
              },
              {
                "name": "MAVEN_ARGS",
                "value": "${MAVEN_ARGS}"
              },
              {
                "name": "MAVEN_ARGS_APPEND",
                "value": "${MAVEN_ARGS_APPEND}"
              },
              {
                "name": "MAVEN_MIRROR_URL",
                "value": "${MAVEN_MIRROR_URL}"
              }
            ]
          }
        },
        "output": {
          "to": {
            "kind": "ImageStreamTag",
            "name": "${APP_NAME}:latest"
          }
        },
        "resources": {
          "requests": {
            "memory": "${BUILD_MEMORY_REQUEST}"
          },
          "limits": {
            "memory": "${BUILD_MEMORY_LIMIT}"
          }
        }
      }
    },
    {
      "kind": "DeploymentConfig",
      "apiVersion": "apps.openshift.io/v1",
      "metadata": {
        "name": "${APP_NAME}",
        "labels": {
          "component": "${APP_NAME}",
          "group": "quickstarts",
          "app": "${APP_NAME}",
          "provider": "s2i",
          "version": "${APP_VERSION}"
        },
        "annotations": {
          "image.openshift.io/triggers": "[{\"from\":{\"kind\":\"ImageStreamTag\",\"name\":\"${APP_NAME}:latest\"},\"fieldPath\":\"spec.template.spec.containers[?(@.name==\\\"${APP_NAME}\\\")].image\"}]"
        }
      },
      "spec": {
        "strategy": {
          "type": "Rolling",
          "rollingParams": {
            "updatePeriodSeconds": 1,
            "intervalSeconds": 1,
            "timeoutSeconds": 3600,
            "maxUnavailable": "25%",
            "maxSurge": "25%"
          },
          "activeDeadlineSeconds": 21600
        },
        "triggers": [
          {
            "type": "ConfigChange"
          },
          {
            "type": "ImageChange",
            "imageChangeParams": {
              "automatic": true,
              "containerNames": [
                "${APP_NAME}"
              ],
              "from": {
                "kind": "ImageStreamTag",
                "name": "${APP_NAME}:latest"
              }
            }
          }
        ],
        "replicas": 1,
        "revisionHistoryLimit": 2,
        "test": false,
        "selector": {
          "app": "${APP_NAME}",
          "group": "quickstarts",
          "provider": "s2i"
        },
        "template": {
          "metadata": {
            "labels": {
              "app": "${APP_NAME}",
              "component": "${APP_NAME}",
              "container": "java",
              "deploymentconfig": "${APP_NAME}",
              "group": "quickstarts",
              "provider": "s2i",
              "version": "${APP_VERSION}",
              "com.company": "Red_Hat",
              "rht.prod_name": "Red_Hat_Integration",
              "rht.prod_ver": "7.11.1",
              "rht.comp": "${APP_NAME}",
              "rht.comp_ver": "${APP_VERSION}"
            }
          },
          "spec": {
            "containers": [
              {
                "name": "${APP_NAME}",
                "image": "library/${APP_NAME}:latest",
                "resources": {
                  "limits": {
                    "cpu": "${CPU_LIMIT}",
                    "memory": "${MEMORY_LIMIT}"
                  },
                  "requests": {
                    "cpu": "${CPU_REQUEST}",
                    "memory": "${MEMORY_REQUEST}"
                  }
                },
                "readinessProbe": {
                  "httpGet": {
                    "path": "/actuator/health",
                    "port": 8081,
                    "scheme": "HTTP"
                  },
                  "initialDelaySeconds": 10,
                  "timeoutSeconds": 1,
                  "periodSeconds": 10,
                  "successThreshold": 1,
                  "failureThreshold": 3
                },
                "terminationMessagePath": "/dev/termination-log",
                "livenessProbe": {
                  "httpGet": {
                    "path": "/actuator/health",
                    "port": 8081,
                    "scheme": "HTTP"
                  },
                  "initialDelaySeconds": 180,
                  "timeoutSeconds": 1,
                  "periodSeconds": 10,
                  "successThreshold": 1,
                  "failureThreshold": 3
                },
                "env": [
                  {
                    "name": "KUBERNETES_NAMESPACE",
                    "valueFrom": {
                      "fieldRef": {
                        "apiVersion": "v1",
                        "fieldPath": "metadata.namespace"
                      }
                    }
                  },
                  {
                    "name": "SPRING_CONFIG_LOCATION",
                    "value":"/etc/config/application.properties"
                  },
                  {
                    "name": "SPRING_CLOUD_KUBERNETES_CONFIG_ENABLED",
                    "value": "false"
                  }
                ],
                "securityContext": {
                  "privileged": false
                },
                "ports": [
                  {
                    "name": "http",
                    "containerPort": 8080,
                    "protocol": "TCP"
                  },
                  {
                    "name": "prometheus",
                    "containerPort": 9779,
                    "protocol": "TCP"
                  },
                  {
                    "name": "jolokia",
                    "containerPort": 8778,
                    "protocol": "TCP"
                  }
                ],
                "imagePullPolicy": "IfNotPresent",
                "terminationMessagePolicy": "File",
                "volumeMounts": [
                  {
                    "name": "config",
                    "mountPath": "/etc/config"
                  }
                ]
              }
            ],
            "restartPolicy": "Always",
            "terminationGracePeriodSeconds": 30,
            "dnsPolicy": "ClusterFirst",
            "serviceAccountName": "${APP_NAME}",
            "serviceAccount": "${APP_NAME}",
            "securityContext": {
            },
            "volumes": [
              {
                "name": "config",
                "configMap": {
                  "name": "spring-boot-camel-rhosak"
                }
              }
            ],
            "schedulerName": "default-scheduler"
          }
        }
      }
    },
    {
      "kind": "ConfigMap",
      "apiVersion": "v1",
      "metadata": {
        "annotations": {
          "description": "ConfigMap to use in the quickstart"
        },
        "labels": {
          "component": "${APP_NAME}",
          "group": "quickstarts",
          "app": "${APP_NAME}",
          "provider": "s2i",
          "version": "${APP_VERSION}"
        },
        "name": "spring-boot-camel-rhosak"
      },
      "data": {
        "application.properties": "# Service Account info\nkafka.client-id=${SA_CLIENT_ID}\nkafka.client-secret=${SA_CLIENT_SECRET}\n\n# URL of the Kafka brokers to use. The format is host1:port1,host2:port2,\n# and the list can be a subset of brokers or a VIP pointing to a subset of brokers.\n# This option is known as bootstrap.servers in the Kafka documentation\nkafka.brokers = ${KAFKA_BROKERS}\n# The Simple Authentication and Security Layer (SASL) Mechanism used. For the\n# valid values see http://www.iana.org/assignments/sasl-mechanisms/sasl-mechanisms.xhtml\nkafka.sasl-mechanism = PLAIN\n# Protocol used to communicate with brokers. Currently only PLAINTEXT and SSL\n# are supported.\nkafka.security-protocol = SASL_SSL\n# Expose the kafka sasl.jaas.config parameter\nkafka.sasl-jaas-config = org.apache.kafka.common.security.plain.PlainLoginModule required username='${SA_CLIENT_ID}' password='${SA_CLIENT_SECRET}';\n# The list of protocols enabled for SSL connections. TLSv1.2, TLSv1.1 and TLSv1 are enabled by default.\nkafka.ssl-enabled-protocols = TLSv1.2,TLSv1.3\n# The SSL protocol used to generate the SSLContext. Default setting is TLS,\n# which is fine for most cases. Allowed values in recent JVMs are TLS, TLSv1.1,\n# TLSv1.2 and TLSv1.3. SSL, SSLv2 and SSLv3 may be supported in older JVMs,\n# but their usage is discouraged due to known security vulnerabilities.\nkafka.ssl-protocol = TLSv1.3\n# The maximum number of records returned in a single call to poll()\nkafka.max-poll-records = ${MAX_POLL_RECORDS}\n# A string that uniquely identifies the group of consumer processes to which\n# this consumer belongs. By setting the same group id multiple processes indicate\n# that they are all part of the same consumer group. This option is required for consumers.\nkafka.group-id = ${CONSUMER_GROUP_ID}\n# Set if KafkaConsumer will read from beginning or end on startup:\n# beginning : read from beginning\n# end : read from end\n# This is replacing the earlier property seekToBeginning\nkafka.seek-to = ${SEEK_TO_STRATEGY}\n# The number of consumers that connect to kafka server\nkafka.consumers-count = ${KAFKA_CONSUMERS_COUNT}\n# Name of the topic to use. On the consumer you can use comma to separate\n# multiple topics. A producer can only send a message to a single topic.\nkafka.topic = ${TOPIC_NAME}\n\n# lets listen on all ports to ensure we can be invoked from the pod IP\nserver.address=0.0.0.0\nmanagement.server.address=0.0.0.0\n\n# lets use a different management port in case you need to listen to HTTP requests on 8080\nmanagement.server.port=8081\n\n# disable all management endpoints except health\nendpoints.enabled = false\nendpoints.health.enabled = true"
      }
    }
  ]
}
